<!DOCTYPE html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]--> 
<html class="no-js" lang="en"> 
  <head>
    <title>Error 404 and report if app plan doesn't match | 3scale Documentation</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href='//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css'>
    <link rel="stylesheet" type="text/css" href='//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css'>
    <link rel="stylesheet" type="text/css" href='/css/jquery.tocify.css'>
    <link rel="stylesheet" type="text/css" href='/css/jquery.ui.all.css'>
    <link rel="stylesheet" type="text/css" href='/css/prototype.css'>
    <link rel="stylesheet" type="text/css" href='/css/syntax.css'>
  

    <script type="text/javascript" src="/javascript/modernizr.js"></script>
    <!--<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>-->
    
  </head>

<body>
  <!-- body content here -->
  <div class="container-fluid">
    <section class="row">
      <header class="fixed-header col-md-12">
        <div class="row">
          <div class="col-md-2 col-xs-4 logo">
            <a href="http://support.3scale.net" style="width: 155px; position: relative;"><img style="
    margin-top: 1px;
" src="https://support.3scale.net/images/3scale-logo-transparent.png"><span style="color: white; position: absolute; font-variant: small-caps; font-family: Verdana; right: 0px; bottom: -24px;">Docs</span></a>
          </div>
          <div class="col-md-6">
            <div class="row" id="search">
              <form action="/search" method="get" class="col-md-10">
                <input class="text" name="q" type="text" id="search-query" title="Search the site" placeholder="Search" autocomplete="off" >
              </form>
              <div class="col-md-2 head-butt"><a class="btn btn-default" href="/"><i class="fa fa-code"></i>CodeHub</a></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="row">               
              <div class="col-md-3 head-butt"><a href="/" class="btn btn-default"><i class="fa fa-book"></i>Docs</a></div>
              <div class="col-md-3 head-butt"><a href="/help" class="btn btn-default"><i class="fa fa-question-circle"></i>Help</a></div>
              <div class="col-md-3 head-butt"><a href="/forum" class="btn btn-default"><i class="fa fa-comments"></i>Forum</a></div>
              <div class="col-md-3 head-butt"><a href="http://www.3scale.net/blog" class="btn btn-default"><i class="fa fa-rss"></i>Blog</a></div>
            </div>
          </div>
        </div>
      </header>
    </section>
    <div class="row document-content">
      <div class="fill col-md-2 col-sm-3 col-xs-4">
          <div class="tocify1">
  <!-- OVERVIEW -->
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/nginx/">nginx</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/lua/">lua</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/authentication/">authentication</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/reporting/">reporting</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/varnish/">varnish</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/html/">html</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/liquid/">liquid</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/js/">js</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/developerportal/">developerportal</a></li>
        
      </ul>
    
      <ul class="tocheader nav nav-list">
        
          <li class="multi"><a href="/caching/">caching</a></li>
        
      </ul>
    
  <!-- CASE STUDIES -->
  <!--<ul class="tocheader nav nav-list">
    <li class=""><a>Case Studies</a></li>
  </ul>-->

  <!-- CODEHUB -->
  <!--<ul class="tocheader nav nav-list">
    <li class=""><a>Code Hub</a></li>
  </ul>-->
</div>
      </div>
      <div class="col-md-10 col-sm-9 col-xs-8">
        <div class="row">
          <div class="col-lg-10 col-md-11 col-sm-12">
            
            <section id="search-results" style="display: none;">
              <h2>Search results</h2>
              <div class="entries">
                
                <script id="search-results-template" type="text/mustache">
                  {{#entries}}
                    <article>
                      <p>
                        {{#date}}<small><time datetime="{{pubdate}}" pubdate>{{displaydate}}</time></small>{{/date}}
                        <a href="{{url}}">{{title}}</a>
                      </p>
                    </article>
                  {{/entries}}
                </script>
                
              </div>
            </section>
            <section id="page-content">        
              <h1>Error 404 and report if app plan doesn't match</h1>
<dl>
	<dt>Author:</dt>
		<dd>Victor Delgado</dd>
	<dt>Version:</dt>
		<dd>1.0</dd>
	<dt>Language:</dt>
		<dd>Lua&Nginx Config</dd>
</dl>
<p><strong>Description:</strong> First of all, some of the money will go directly to the speakers to compensate their costs to come to Barcelona and give some great talks. If that's not convincing enough, we'll serve you refreshments, have two coffee breaks and a lunch break. And we're not talking conference food, but a Mediterranean-style menu, tapas, sandwiches and other snacks prepared by awesome local chefs.</p>

<h3>nginx.conf</h3>
<div class="highlight"><pre><code class="language-nginx" data-lang="nginx"><span class="lineno">1</span> <span class="k">location</span> <span class="p">=</span> <span class="s">/threescale_report</span> <span class="p">{</span>
<span class="lineno">2</span> <span class="kn">internal</span><span class="p">;</span>
<span class="lineno">3</span> <span class="kn">set</span> <span class="nv">$provider_key</span> <span class="s">&quot;PROVIDERKEY&quot;</span><span class="p">;</span>
<span class="lineno">4</span>  
<span class="lineno">5</span> <span class="kn">proxy_pass</span> <span class="s">http://threescale_backend/transactions.xml</span><span class="p">;</span>
<span class="lineno">6</span> <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="s">&quot;su1.3scale.net&quot;</span><span class="p">;</span>
<span class="lineno">7</span> <span class="p">}</span></code></pre></div>

<h3>nginx.lua</h3>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="lineno"> 1</span> <span class="c1">--------------------------------------</span>
<span class="lineno"> 2</span> <span class="c1">-- authrep ---------------------------</span>
<span class="lineno"> 3</span> <span class="c1">--------------------------------------</span>
<span class="lineno"> 4</span> <span class="k">function</span> <span class="nf">authrep</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>
<span class="lineno"> 5</span> <span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">cached_key</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">cached_key</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s">:&quot;</span> <span class="o">..</span> <span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">usage</span>
<span class="lineno"> 6</span> <span class="kd">local</span> <span class="n">api_keys</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">api_keys</span>
<span class="lineno"> 7</span> <span class="kd">local</span> <span class="n">is_known</span> <span class="o">=</span> <span class="n">api_keys</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">cached_key</span><span class="p">)</span>
<span class="lineno"> 8</span>  
<span class="lineno"> 9</span> <span class="k">if</span> <span class="n">is_known</span> <span class="o">~=</span> <span class="mi">200</span> <span class="k">then</span>
<span class="lineno">10</span> <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">capture</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/threescale_authrep&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">share_all_vars</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
<span class="lineno">11</span>  
<span class="lineno">12</span> <span class="c1">-- IN HERE YOU DEFINE THE ERROR IF CREDENTIALS ARE PASSED, BUT THEY ARE NOT VALID</span>
<span class="lineno">13</span> <span class="k">if</span> <span class="n">res</span><span class="p">.</span><span class="n">status</span> <span class="o">~=</span> <span class="mi">200</span> <span class="k">then</span>
<span class="lineno">14</span> <span class="c1">-- remove the key, if it&#39;s not 200 let&#39;s go the slow route, to 3scale&#39;s backend</span>
<span class="lineno">15</span> <span class="n">api_keys</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">cached_key</span><span class="p">)</span>
<span class="lineno">16</span> <span class="n">ngx</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">status</span>
<span class="lineno">17</span> <span class="n">ngx</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">application/json&quot;</span>
<span class="lineno">18</span> <span class="n">error_authorization_failed</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
<span class="lineno">19</span> <span class="k">else</span>
<span class="lineno">20</span> <span class="c1">-- check for application plan in authrep response</span>
<span class="lineno">21</span> <span class="kd">local</span> <span class="n">qa_plan</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">body</span><span class="p">,</span><span class="s">[=[&lt;plan&gt;.+QA]=]</span><span class="p">)</span>
<span class="lineno">22</span>  
<span class="lineno">23</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">qa_plan</span> <span class="k">then</span>
<span class="lineno">24</span> <span class="c1">-- if application plan is not &quot;Sandbox&quot; report</span>
<span class="lineno">25</span> <span class="c1">-- to 3scale and return 404 error to the client</span>
<span class="lineno">26</span> <span class="kd">local</span> <span class="n">transaction</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">transactions[0][app_id]=&quot;</span> <span class="o">..</span> <span class="n">params</span><span class="p">.</span><span class="n">app_id</span> <span class="o">..</span>
<span class="lineno">27</span> <span class="s2">&quot;</span><span class="s">&amp;transactions[0][usage][hits]=1&quot;</span>
<span class="lineno">28</span>  
<span class="lineno">29</span> <span class="kd">local</span> <span class="n">report_body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">provider_key=&quot;</span> <span class="o">..</span> <span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">provider_key</span> <span class="o">..</span>
<span class="lineno">30</span> <span class="s2">&quot;</span><span class="s">&amp;service_id=&quot;</span> <span class="o">..</span> <span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">service_id</span> <span class="o">..</span>
<span class="lineno">31</span> <span class="s2">&quot;</span><span class="s">&amp;transactions=&quot;</span> <span class="o">..</span> <span class="n">transaction</span>
<span class="lineno">32</span>  
<span class="lineno">33</span> <span class="n">ngx</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">capture</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">/threescale_report&quot;</span><span class="p">,</span> <span class="p">{</span>
<span class="lineno">34</span> <span class="n">method</span> <span class="o">=</span> <span class="n">ngx</span><span class="p">.</span><span class="n">HTTP_POST</span><span class="p">,</span>
<span class="lineno">35</span> <span class="n">body</span> <span class="o">=</span> <span class="n">report_body</span><span class="p">,</span>
<span class="lineno">36</span> <span class="n">share_all_vars</span> <span class="o">=</span> <span class="kc">true</span>
<span class="lineno">37</span> <span class="p">})</span>
<span class="lineno">38</span> <span class="n">error_no_match</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
<span class="lineno">39</span> <span class="k">end</span>
<span class="lineno">40</span>  
<span class="lineno">41</span> <span class="n">api_keys</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">cached_key</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
<span class="lineno">42</span> <span class="k">end</span>
<span class="lineno">43</span> <span class="n">ngx</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">cached_key</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="lineno">44</span> <span class="k">end</span>
<span class="lineno">45</span> <span class="k">end</span></code></pre></div>       
            </section> 
            <!-- DISQUS -->
            
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                  var disqus_shortname = 'testandrzej'; // required: replace example with your forum shortname

                  /* * * DON'T EDIT BELOW THIS LINE * * */
                  (function() {
                      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
              </script>
              <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                            
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- JS and analytics only. -->

    <!--<script src="/javascripts/bootstrap.min.js"></script>-->
    <script src="/javascript/search.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" src="/javascript/jquery-ui-1.9.1.custom.min.js"></script>
    <!--<script type="text/javascript" src="/javascript/baseline.js"></script>
    <script type="text/javascript" src="/javascript/3scale.js"></script>-->
    <script type="text/javascript" src="/javascript/excanvas.compiled.js"></script>
    
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6/html5shiv.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  
  <script>
      //$("#navigation").tocify({ selectors: "h1.menu,h2.menu", theme: "bootstrap", extendPage: false });
    $(".logo a").css("margin-left", $("#navigation").css("margin-left"));

    // collapsible menu
    $(function() {
      $('a').click(function(e) {
        
            
        $('html, body').animate( { scrollTop: $($.attr(this, 'href')).offset().top+'px' }, 500);
      });
      $('.multi').click(function(e) {
        if ($(this).children('#navigation').length == 0 ) {
          $(this).next('.tocsubheader').slideToggle();
          $(this).find('.fa').toggleClass("fa-chevron-left fa-chevron-down");
        }
        else {
          //$(this).find('#navigation ul ul').slideToggle();
        }
      });

      //Current position highlight
      var aChildren = $(".tocify1 .tocheader #this li").children();
      var aArray = [];
      for (var i=0; i< aChildren.length; i++) {
        var aChild = aChildren[i];
        var ahref = $(aChild).attr('href');
        aArray.push(ahref);
      }

      $(window).scroll(function() {
        var windowPos = $(window).scrollTop();
        var windowHeight = $(window).height();
        var docHeight = $(document).height();

        for (var i=0; i< aArray.length; i++) {
          var theID = aArray[i];
          var divPos = $(theID).offset().top-1;
          var divHeight = $(theID).parent().parent().height();
          if (windowPos >= divPos && windowPos < (divPos + divHeight)) {
            $("a[href='" + theID + "']").parent().addClass('active');
          } else {
            $("a[href='" + theID + "']").parent().removeClass('active');
          }
        }

        if(windowPos + windowHeight == docHeight) {
          if (!$(".tocify1 .tocheader #this li:last-child a").parent().hasClass('active')) {
            var navActiveCurrent = $('.active').child().attr('href');
            $("a[href='" + navActiveCurrent + "']").removeClass('active');
            $(".tocify1 .tocheader #this li:last-child").addClass('active');
          }
        }
      });

    });
    /*$('.document-content img').baseline(30);
    $('#search a').click(function(e) {
      $("#search").submit();
    });*/
  $(function() {
    $('#search-query').lunrSearch({
      indexUrl: '/search.json',             // URL of the `search.json` index data for your site
      results:  '#search-results',          // jQuery selector for the search results container
      entries:  '.entries',                 // jQuery selector for the element to contain the results list, must be a child of the results element above.
      template: '#search-results-template'  // jQuery selector for the Mustache.js template
    });
    $("#search-query").keydown(function(event) {
      if(event.keyCode == 13) {
        event.preventDefault();
        return false;
      }
      $(this).val() ? $("#search-results").hide() : $("#search-results").show();
    });
    $("#search-query").keyup(function() {
      if ($(this).val() ) {
        $("#page-content").css("display", "none");
      } else {
        $("#page-content").css("display", "block");
      }
    });
  });
  </script> 
  <script type="text/javascript">
      $(function() {
        $('.multi > a').each(function() {
          if(window.location.pathname == $(this).attr('href'))
            $(this).parent().addClass('active');
        });
      });
    </script>
  </body>
</html>
